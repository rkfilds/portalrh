@model PageSeedViewModel
@{
	ViewData["Title"] = "Portal RH • Ambiente DEV — Triagem";
	ViewData["SidebarSubtitle"] = "Triagem • Pipeline";
}



<!-- ============ MODALS ============ -->
@await Html.PartialAsync("_ModalDecision")

@await Html.PartialAsync("_ModalTriagemDetalhes")

<!-- ============ TOASTS ============ -->
@await Html.PartialAsync("_Toast")

@section Topbar {
	@await Html.PartialAsync("_TopbarBrand", "Tela: Triagem (pipeline + decisão rápida)")

	<div class="d-flex align-items-center gap-2">
		<button class="btn btn-ghost" type="button" id="btnSeedReset" title="Restaurar demo">
			<i class="bi bi-arrow-counterclockwise"></i><span class="d-none d-sm-inline ms-1">Reset demo</span>
		</button>

		<button class="btn btn-ghost" type="button" id="btnExportJson" title="Exportar triagem (JSON)">
			<i class="bi bi-download"></i><span class="d-none d-sm-inline ms-1">Exportar</span>
		</button>

		<button class="btn btn-ghost" type="button" id="btnImportJson" title="Importar (JSON)">
			<i class="bi bi-upload"></i><span class="d-none d-sm-inline ms-1">Importar</span>
		</button>

		<button class="btn btn-brand" type="button" id="btnAutoTriage">
			<i class="bi bi-lightning-charge"></i><span class="d-none d-sm-inline ms-1">Auto-triagem</span>
		</button>

		@await Html.PartialAsync("_TopbarUserMenu", "RH")
	</div>
}

<!-- CONTENT -->
<section class="content">
	<div class="page-title">
		<div>
			<h4>Triagem</h4>
			<div class="subtitle">Pipeline de análise: Em triagem → Pendente → Aprovado/Reprovado (com match e requisitos).</div>
		</div>
		<div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
			<span class="badge-soft"><i class="bi bi-clock me-1"></i><span id="nowLabel">—</span></span>
			<span class="badge-soft"><i class="bi bi-stars me-1"></i>Match por vaga</span>
		</div>
	</div>

	<!-- Board -->
	<div class="row g-3">

		<div class="col-12 col-lg-6 col-xl-3">
			<div class="stage-col" data-stage="triagem">
				<div class="stage-header">
					<div>
						<p class="stage-title mb-0"><i class="bi bi-funnel me-1"></i>Em triagem</p>
						<div class="stage-meta"><span id="countTriagem">0</span> candidatos</div>
					</div>
					<span class="pill"><i class="bi bi-hand-index"></i>arraste</span>
				</div>
				<div class="stage-drop" id="dropTriagem">
					<div class="drop-hint mb-2"><i class="bi bi-info-circle me-1"></i>Solte aqui candidatos para revisar.</div>
					<lt-list id="listTriagem"></lt-list>
				</div>
			</div>
		</div>

		<div class="col-12 col-lg-6 col-xl-3">
			<div class="stage-col" data-stage="pendente">
				<div class="stage-header">
					<div>
						<p class="stage-title mb-0"><i class="bi bi-hourglass-split me-1"></i>Pendente</p>
						<div class="stage-meta"><span id="countPendente">0</span> candidatos</div>
					</div>
					<span class="pill"><i class="bi bi-clipboard-check"></i>validar</span>
				</div>
				<div class="stage-drop" id="dropPendente">
					<div class="drop-hint mb-2"><i class="bi bi-info-circle me-1"></i>Ex.: aguardando retorno, teste, entrevista.</div>
					<lt-list id="listPendente"></lt-list>
				</div>
			</div>
		</div>

		<div class="col-12 col-lg-6 col-xl-3">
			<div class="stage-col" data-stage="aprovado">
				<div class="stage-header">
					<div>
						<p class="stage-title mb-0"><i class="bi bi-check2-circle me-1"></i>Aprovado</p>
						<div class="stage-meta"><span id="countAprovado">0</span> candidatos</div>
					</div>
					<span class="pill"><i class="bi bi-arrow-right-circle"></i>avançar</span>
				</div>
				<div class="stage-drop" id="dropAprovado">
					<div class="drop-hint mb-2"><i class="bi bi-info-circle me-1"></i>Dentro do perfil (match + análise).</div>
					<lt-list id="listAprovado"></lt-list>
				</div>
			</div>
		</div>

		<div class="col-12 col-lg-6 col-xl-3">
			<div class="stage-col" data-stage="reprovado">
				<div class="stage-header">
					<div>
						<p class="stage-title mb-0"><i class="bi bi-x-circle me-1"></i>Reprovado</p>
						<div class="stage-meta"><span id="countReprovado">0</span> candidatos</div>
					</div>
					<span class="pill"><i class="bi bi-archive"></i>encerrar</span>
				</div>
				<div class="stage-drop" id="dropReprovado">
					<div class="drop-hint mb-2"><i class="bi bi-info-circle me-1"></i>Sem aderência (obrigatório faltando / fora do mínimo).</div>
					<lt-list id="listReprovado"></lt-list>
				</div>
			</div>
		</div>
	</div>

	<div style="height: 14px;"></div>
</section>

<!-- Templates -->
<template id="tpl-tri-tag">
	<span class="status-tag">
		<i class="bi" data-role="icon"></i>
		<span data-role="text"></span>
	</span>
</template>

<template id="tpl-tri-empty">
	<div class="text-muted small">-</div>
</template>

<template id="tpl-tri-card">
	<div class="tri-item cand-card">
		<div class="tri-item-head">
			<div class="d-flex align-items-center gap-2">
				<div class="avatar" data-role="cand-initials"></div>
				<div>
					<div class="name d-flex align-items-center gap-2 flex-wrap">
						<span data-role="cand-name"></span>
						<button class="btn btn-ghost btn-sm" type="button" title="Detalhes" aria-label="Detalhes" data-act="details">
							<i class="bi bi-eye"></i>
						</button>
					</div>
					<div class="smalltxt" data-role="cand-email"></div>
				</div>
			</div>

			<div class="tri-meta text-end">
				<div class="pill mono" data-role="vaga-code"></div>
				<div class="smalltxt mt-1" data-role="vaga-title"></div>
			</div>
		</div>

		<div class="matchline">
			<div class="flex-grow-1">
				<div class="d-flex align-items-center gap-2">
					<div class="progress flex-grow-1">
						<div class="progress-bar" data-role="match-progress"></div>
					</div>
					<div class="fw-bold" style="min-width:44px;text-align:right;" data-role="match-score"></div>
				</div>
				<div class="smalltxt mt-1">
					minimo: <span class="mono" data-role="match-thr"></span>
					<span class="mx-1">&bull;</span>
					<span class="fw-semibold" data-role="match-status"></span>
				</div>
			</div>
		</div>

		<div class="d-flex flex-wrap gap-2 mt-2">
			<div class="d-flex flex-wrap gap-2" data-role="tri-tags"></div>
			<button class="btn btn-ghost btn-sm ms-auto" type="button" data-act="decision">
				<i class="bi bi-clipboard-check me-1"></i>Decisao
			</button>
		</div>
	</div>
</template>

<template id="tpl-tri-detail-empty">
	<div class="detail-empty">
		<div class="d-flex align-items-start gap-2">
			<i class="bi bi-info-circle mt-1"></i>
			<div>
				<div class="fw-bold">Selecione um candidato</div>
				<div class="small mt-1">Clique em um card para ver detalhes, match e historico de triagem.</div>
			</div>
		</div>
	</div>
</template>

<template id="tpl-tri-detail">
	<div class="card-soft p-3">
		<div class="d-flex flex-wrap align-items-start justify-content-between gap-2 mb-2">
			<div class="d-flex align-items-center gap-2">
				<div class="avatar" style="width:52px;height:52px;border-radius:16px;" data-role="detail-initials"></div>
				<div>
					<div class="fw-bold" style="font-size:1.05rem;" data-role="detail-name"></div>
					<div class="text-muted small" data-role="detail-email"></div>
					<div class="text-muted small">
						<i class="bi bi-clock-history me-1"></i>Atualizado: <span data-role="detail-updated"></span>
					</div>
				</div>
			</div>

			<div class="text-end">
				<div data-role="detail-status-host"></div>
				<div class="text-muted small mt-1"><i class="bi bi-alarm me-1"></i>SLA: <span class="fw-semibold" data-role="detail-sla"></span></div>
			</div>
		</div>

		<div class="d-flex flex-wrap gap-2 mb-3">
			<span class="pill"><i class="bi bi-briefcase"></i><span data-role="detail-vaga-title"></span></span>
			<span class="pill mono" data-role="detail-vaga-code-wrap"><span data-role="detail-vaga-code"></span></span>
			<span class="pill" data-role="detail-vaga-thr-wrap"><i class="bi bi-stars"></i>Min.: <strong class="ms-1" data-role="detail-vaga-thr"></strong></span>
		</div>

		<div class="d-flex align-items-center justify-content-between">
			<div>
				<div class="fw-bold">Match atual</div>
				<div class="text-muted small">MVP por palavras-chave</div>
			</div>
			<div data-role="detail-match-host"></div>
		</div>

		<div class="mt-2">
			<div class="progress">
				<div class="progress-bar" data-role="detail-match-progress"></div>
			</div>
			<div class="text-muted small mt-1">
				Encontrados: <strong data-role="detail-match-hits"></strong>
				<span class="mx-1">&bull;</span> Obrigatorios faltando: <strong data-role="detail-match-miss"></strong>
			</div>
		</div>

		<div class="alert alert-danger mt-3 mb-0 d-none" style="border-radius:14px;" data-role="detail-miss-alert">
			<div class="fw-semibold mb-1"><i class="bi bi-exclamation-triangle me-1"></i>Obrigatorios faltando</div>
			<div class="small" data-role="detail-miss-list"></div>
		</div>

		<div class="alert alert-success mt-3 mb-0 d-none" style="border-radius:14px;" data-role="detail-hit-alert">
			<div class="fw-semibold mb-1"><i class="bi bi-check2 me-1"></i>Obrigatorios OK</div>
			<div class="small" data-role="detail-hit-list"></div>
		</div>

		<div class="d-flex flex-wrap gap-2 mt-3">
			<button class="btn btn-brand btn-sm" type="button" data-dact="decision">
				<i class="bi bi-clipboard-check me-1"></i>Decisao
			</button>
			<button class="btn btn-ghost btn-sm" type="button" data-dact="recalc">
				<i class="bi bi-arrow-repeat me-1"></i>Recalcular match
			</button>
		</div>

		<hr class="my-3" style="border-color: rgba(16,82,144,.14);">

		<div class="fw-bold mb-1">Historico de triagem</div>
		<div class="text-muted small mb-2">Ultimas movimentacoes (MVP localStorage).</div>

		<lt-list class="list-group" style="border-radius: 14px; overflow:hidden;" data-role="tri-log-list"></lt-list>
	</div>
</template>

<template id="tpl-tri-log-item">
	<div class="list-group-item">
		<div class="d-flex align-items-start justify-content-between gap-2">
			<div>
				<div class="fw-semibold" data-role="log-title"></div>
				<div class="text-muted small" data-role="log-note"></div>
			</div>
			<div class="text-muted small nowrap" data-role="log-time"></div>
		</div>
	</div>
</template>

<template id="tpl-tri-log-empty">
	<div class="detail-empty">
		<div class="small">Sem historico ainda. Use Decisao ou arraste para registrar uma movimentacao.</div>
	</div>
</template>

@section Footer {
	@{
		var footerItems = new[]
		{
			new { Icon = "bi-funnel", Text = "Triagem" },
			new { Icon = "bi-stars", Text = "Match" },
			new { Icon = "bi-shield-check", Text = "LGPD" }
		  };
	}
	@await Html.PartialAsync("_Footer", footerItems)
      }



<!-- Bootstrap JS (CDN) -->
@section Scripts {
	<script>
		window.__candidatosApiUrl = "@Url.Content("~/api/candidatos")";
		window.__seedData = @Html.Raw(Model.SeedJson);
	</script>
	<script src="~/js/views/triagem.js" asp-append-version="true"></script>
}
