@model LioTecnica.Web.ViewModels.Authentication.LoginViewModel
@{
    Layout = null;
}
<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <style>
        body { background: var(--lt-bg); color: var(--lt-text); }
        .login-card {
            max-width: 420px;
            background: var(--lt-card);
            border-color: var(--lt-border);
            box-shadow: var(--lt-shadow);
        }
        .health-row { font-size: .8rem; color: var(--lt-muted); }
        .health-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            display: inline-block;
            box-shadow: 0 0 0 2px rgba(12,58,100,.12);
        }
        .status-ok { background: #1db954; }
        .status-warn { background: #f5a524; }
        .status-down { background: #e23b3b; }
        .status-unknown { background: #cbd5e1; }
    </style>
</head>
<body class="d-flex align-items-center justify-content-center min-vh-100">
    <div class="position-absolute top-0 end-0 p-3">
        <div class="btn-group theme-toggle-group" role="group" aria-label="Tema">
            <button type="button" class="btn btn-ghost theme-toggle" data-theme="clean" aria-pressed="false">
                <i class="bi bi-brightness-high"></i><span class="d-none d-sm-inline">Clean</span>
            </button>
            <button type="button" class="btn btn-ghost theme-toggle" data-theme="dark" aria-pressed="false">
                <i class="bi bi-moon-stars"></i><span class="d-none d-sm-inline">Dark</span>
            </button>
        </div>
    </div>
    <div class="card shadow-sm login-card w-100">
        <div class="card-body p-4">
            <h1 class="h4 mb-3">Portal Login</h1>
            <form method="post" action="/Account/Login">
                <input type="hidden" asp-for="ReturnUrl" />
                <div class="mb-3">
                    <label class="form-label" asp-for="TenantId">Tenant</label>
                    <input class="form-control" asp-for="TenantId" autocomplete="organization" />
                    <span class="text-danger small" asp-validation-for="TenantId"></span>
                </div>
                <div class="mb-3">
                    <label class="form-label" asp-for="Email">Email</label>
                    <input class="form-control" asp-for="Email" autocomplete="username" />
                    <span class="text-danger small" asp-validation-for="Email"></span>
                </div>
                <div class="mb-3">
                    <label class="form-label" asp-for="Password">Password</label>
                    <input class="form-control" asp-for="Password" type="password" autocomplete="current-password" />
                    <span class="text-danger small" asp-validation-for="Password"></span>
                </div>
                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert alert-danger py-2">Login failed. Check your credentials.</div>
                }
                <button type="submit" class="btn btn-primary w-100">Sign in</button>
            </form>
            <div class="d-flex align-items-center gap-2 mt-3 health-row" id="loginHealth" aria-live="polite">
                <span class="fw-semibold">API</span>
                <span class="health-dot status-unknown" data-health="api" title="API: unknown"></span>
                <span class="fw-semibold">DB</span>
                <span class="health-dot status-unknown" data-health="db" title="DB: unknown"></span>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script>
        (() => {
            const root = document.getElementById("loginHealth");
            if (!root) return;
            const apiDot = root.querySelector('[data-health="api"]');
            const dbDot = root.querySelector('[data-health="db"]');
            const statusClasses = ["status-ok", "status-warn", "status-down", "status-unknown"];

            const normalize = (value) => (value ?? "").toString().trim().toLowerCase();
            const mapStatus = (value) => {
                const text = normalize(value);
                if (text === "healthy") return "status-ok";
                if (text === "degraded") return "status-warn";
                if (text === "unhealthy") return "status-down";
                return "status-unknown";
            };

            const setDot = (dot, status, label) => {
                if (!dot) return;
                statusClasses.forEach(cls => dot.classList.remove(cls));
                dot.classList.add(status);
                if (label) dot.title = label;
            };

            const update = async () => {
                try {
                    const res = await fetch("/api/health", { headers: { "Accept": "application/json" }, credentials: "same-origin" });
                    const data = await res.json().catch(() => null);
                    if (!res.ok && !data) throw new Error(`health ${res.status}`);
                    const apiStatus = data?.status ?? "unknown";
                    setDot(apiDot, mapStatus(apiStatus), `API: ${apiStatus}`);

                    const checks = Array.isArray(data?.checks) ? data.checks : [];
                    const dbCheck = checks.find(c => normalize(c?.name) === "database");
                    const dbStatus = dbCheck?.status ?? "unknown";
                    setDot(dbDot, mapStatus(dbStatus), `DB: ${dbStatus}`);
                } catch (err) {
                    setDot(apiDot, "status-down", "API: down");
                    setDot(dbDot, "status-down", "DB: down");
                }
            };

            update();
            setInterval(update, 30000);
        })();
    </script>
</body>
</html>
