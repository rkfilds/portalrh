@{
    ViewData["Title"] = "Portal RH • Liotécnica — Candidatos";
    ViewData["SidebarSubtitle"] = "Candidatos • CV • Match";
}

@section Styles {
<style>
:root{
      --lt-primary: #0C3A64;
      --lt-brand:   #105291;
      --lt-soft:    #ADC8DC;
      --lt-bg:      #F6F9FC;
      --lt-card:    #FFFFFF;
      --lt-text:    #0D1B2A;
      --lt-muted:   rgba(13,27,42,.65);
      --lt-border:  rgba(16,82,144,.18);
      --lt-shadow:  0 10px 30px rgba(11,58,100,.10);
      --radius-xl:  18px;
      --radius-lg:  14px;
      --ui-scale:  .75;
    }

    html, body { height: 100%; }
    body{
      background: radial-gradient(1100px 480px at 15% 0%, rgba(173,200,220,.30), transparent 55%),
                  radial-gradient(900px 520px at 85% 10%, rgba(16,82,144,.16), transparent 55%),
                  var(--lt-bg);
      color: var(--lt-text);
      zoom: var(--ui-scale);
    }

    .app-shell{
      min-height: 100vh;
      display: grid;
      grid-template-columns: 290px 1fr;
    }

    /* Sidebar */
    .sidebar{
      background: linear-gradient(180deg, rgba(11,58,100,1) 0%, rgba(16,82,144,1) 100%);
      color: rgba(255,255,255,.92);
      border-right: 1px solid rgba(255,255,255,.12);
      position: sticky;
      top: 0;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar-inner{
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:.75rem;
      padding: 1rem 1rem .75rem 1rem;
    }
    .brand img{
      width: 38px; height: 38px;
      border-radius: 10px;
      background: #fff;
      padding: 6px;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      object-fit: contain;
    }
    .brand .title{ line-height: 1.05; }
    .brand .title strong{
      display:block;
      font-size: 1.02rem;
      letter-spacing: .2px;
    }
    .brand .title span{
      display:block;
      font-size: .78rem;
      opacity: .85;
    }
    .sidebar .nav-section{
      padding: .35rem 1rem;
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .12em;
      opacity: .75;
      margin-top: .35rem;
    }
    .sidebar .nav-link{
      color: rgba(255,255,255,.88);
      border-radius: 12px;
      padding: .60rem .80rem;
      display:flex;
      align-items:center;
      gap:.65rem;
      margin: .10rem .75rem;
      border: 1px solid transparent;
    }
    .sidebar .nav-link:hover{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.12);
      color: #fff;
    }
    .sidebar .nav-link.active{
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.22);
      color: #fff;
    }
    .sidebar .nav-link i{ font-size: 1.05rem; opacity: .95; }
    .sidebar-footer{
      margin-top:auto;
      padding: .9rem 1rem 1.1rem;
      border-top: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.06);
    }
    .sidebar-footer .pill{
      display:inline-flex;
      gap:.4rem;
      align-items:center;
      padding: .35rem .55rem;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      font-size: .78rem;
    }

    /* Main */
    .main{
      display:flex;
      flex-direction: column;
      min-width: 0;
    }
    .topbar{
      position: sticky;
      top: 0;
      z-index: 1020;
      background: rgba(246,249,252,.78);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--lt-border);
    }
    .topbar-inner{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 1rem;
      padding: .85rem 1rem;
    }
    .searchbox{
      max-width: 620px;
      width: 100%;
    }
    .searchbox .form-control{
      border-radius: 999px;
      padding-left: 2.35rem;
      border-color: var(--lt-border);
      box-shadow: none;
    }
    .searchbox .bi{
      position:absolute;
      left: .85rem;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(11,58,100,.75);
    }

    .content{
      padding: 1rem 1rem 0;
      flex: 1 1 auto;
      min-width: 0;
    }
    .page-title{
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: .9rem;
    }
    .page-title h4{
      margin:0;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .page-title .subtitle{
      color: var(--lt-muted);
      font-size: .92rem;
      margin-top: .15rem;
    }

    .card-soft{
      background: var(--lt-card);
      border: 1px solid var(--lt-border);
      border-radius: var(--radius-xl);
      box-shadow: var(--lt-shadow);
    }

    .btn-brand{
      background: linear-gradient(90deg, var(--lt-brand), var(--lt-primary));
      border: none;
      color: #fff;
      border-radius: 999px;
      padding: .55rem .9rem;
    }
    .btn-brand:hover{ filter: brightness(1.02); color:#fff; }
    .btn-ghost{
      border-radius: 999px;
      border: 1px solid var(--lt-border);
      background: rgba(255,255,255,.65);
    }

    .badge-soft{
      border: 1px solid rgba(16,82,144,.22);
      background: rgba(173,200,220,.25);
      color: var(--lt-primary);
      font-weight: 700;
      border-radius: 999px;
      padding: .35rem .55rem;
    }

    .kpi{
      padding: 1rem;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 1rem;
    }
    .kpi .meta{ display:flex; flex-direction: column; gap: .15rem; }
    .kpi .meta .label{ font-size: .86rem; color: var(--lt-muted); }
    .kpi .meta .value{ font-size: 1.55rem; font-weight: 900; letter-spacing: .2px; }
    .kpi .meta .hint{ font-size: .80rem; color: rgba(13,27,42,.58); }
    .kpi .icon{
      width: 46px;
      height: 46px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      border: 1px solid rgba(16,82,144,.22);
      background: linear-gradient(180deg, rgba(173,200,220,.55), rgba(173,200,220,.18));
      color: var(--lt-primary);
      flex: 0 0 auto;
    }
    .kpi .icon i{ font-size: 1.2rem; }

    .table thead th{
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: rgba(13,27,42,.60);
      border-bottom-color: var(--lt-border) !important;
      white-space: nowrap;
    }
    .table td{
      vertical-align: middle;
      border-top-color: rgba(16,82,144,.10);
    }
    .nowrap{ white-space: nowrap; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .mini-title{
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .10em;
      color: rgba(13,27,42,.55);
      margin: 0;
    }

    .footer{
      padding: 1rem;
      border-top: 1px solid var(--lt-border);
      color: var(--lt-muted);
      font-size: .90rem;
      background: rgba(255,255,255,.35);
    }

    /* Candidate cards + avatar */
    .avatar{
      width: 44px; height: 44px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      background: rgba(173,200,220,.28);
      border: 1px solid rgba(16,82,144,.18);
      color: var(--lt-primary);
      font-weight: 900;
      letter-spacing: .2px;
      flex: 0 0 auto;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding: .30rem .55rem;
      border-radius: 999px;
      border: 1px solid rgba(16,82,144,.18);
      background: rgba(255,255,255,.65);
      font-size: .82rem;
      color: rgba(13,27,42,.78);
      white-space: nowrap;
    }

    .status-tag{
      border-radius: 999px;
      padding: .30rem .6rem;
      font-weight: 700;
      border: 1px solid rgba(16,82,144,.18);
      background: rgba(173,200,220,.20);
      color: var(--lt-primary);
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      white-space: nowrap;
    }
    .status-tag.ok{
      border-color: rgba(25,135,84,.25);
      background: rgba(25,135,84,.10);
      color: rgba(25,135,84,.95);
    }
    .status-tag.warn{
      border-color: rgba(255,193,7,.40);
      background: rgba(255,193,7,.16);
      color: rgba(120,88,0,.95);
    }
    .status-tag.bad{
      border-color: rgba(220,53,69,.30);
      background: rgba(220,53,69,.12);
      color: rgba(153,19,34,.95);
    }

    .progress{
      height: 10px;
      background: rgba(16,82,144,.10);
      border-radius: 999px;
    }
    .progress-bar{
      background: linear-gradient(90deg, var(--lt-brand), var(--lt-primary));
      border-radius: 999px;
    }

    .detail-empty{
      border: 1px dashed rgba(16,82,144,.30);
      border-radius: var(--radius-xl);
      padding: 1.2rem;
      background: rgba(255,255,255,.55);
      color: rgba(13,27,42,.70);
    }

    .offcanvas-custom{
      border-left: 1px solid var(--lt-border);
      box-shadow: -20px 0 40px rgba(11,58,100,.12);
    }

    /* Mobile */
    @@media (max-width: 991.98px){
      .app-shell{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }.content{ padding: .9rem .9rem 0; }
    }

    /* Toast */
    .toast{
      border-radius: 14px;
      border: 1px solid rgba(16,82,144,.18);
      box-shadow: var(--lt-shadow);
    }
</style>
}
  <!-- ============ MODAL: DETALHES DO CANDIDATO ============ -->
  <div class="modal fade" id="modalCandDetalhes" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content" style="border-radius: 18px; border: 1px solid var(--lt-border);">
        <div class="modal-header">
          <div>
            <h5 class="modal-title fw-bold">Detalhes do candidato</h5>
            <div class="text-muted small">Match, historico e status</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailHost"></div>
      </div>
    </div>
  </div>

<!-- ============ MODAL: NOVO/EDITAR CANDIDATO ============ -->
  <div class="modal fade" id="modalCand" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content" style="border-radius: 18px; border: 1px solid var(--lt-border);">
        <div class="modal-header">
          <div>
            <h5 class="modal-title fw-bold" id="modalCandTitle">Novo candidato</h5>
            <div class="text-muted small">Dados básicos + vínculo com vaga (para triagem/match).</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="candId">

          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label small text-muted">Nome *</label>
              <input class="form-control" id="candNome" placeholder="Ex.: Mariana Souza">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label small text-muted">Email *</label>
              <input class="form-control" id="candEmail" placeholder="ex.: mariana@email.com">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label small text-muted">Telefone</label>
              <input class="form-control" id="candFone" placeholder="(11) 99999-9999">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label small text-muted">Cidade</label>
              <input class="form-control" id="candCidade" placeholder="Ex.: Embu das Artes">
            </div>

            <div class="col-12 col-md-2">
              <label class="form-label small text-muted">UF</label>
              <input class="form-control" id="candUF" placeholder="SP" maxlength="2">
            </div>

            <div class="col-12 col-md-2">
              <label class="form-label small text-muted">Fonte</label>
              <select class="form-select" id="candFonte">
                <option>Email</option>
                <option>Pasta</option>
                <option>LinkedIn</option>
                <option>Indicação</option>
                <option>Site</option>
              </select>
            </div>

            <div class="col-12 col-md-7">
              <label class="form-label small text-muted">Vaga *</label>
              <select class="form-select" id="candVaga"></select>
              <div class="form-text">No MVP, vagas são carregadas do localStorage.</div>
            </div>

            <div class="col-12 col-md-5">
              <label class="form-label small text-muted">Status *</label>
              <select class="form-select" id="candStatus">
                <option value="novo">Novo</option>
                <option value="triagem">Em triagem</option>
                <option value="aprovado">Aprovado</option>
                <option value="reprovado">Reprovado</option>
                <option value="pendente">Pendente</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label small text-muted">Resumo / Observações</label>
              <textarea class="form-control" id="candObs" rows="3" placeholder="Observações do RH, highlights, etc."></textarea>
            </div>

            <div class="col-12">
              <div class="alert alert-primary mb-0" style="border-radius: 14px; border-color: rgba(16,82,144,.25); background: rgba(173,200,220,.22); color: var(--lt-primary);">
                <div class="d-flex align-items-start gap-2">
                  <i class="bi bi-file-earmark-text mt-1"></i>
                  <div>
                    <div class="fw-semibold">CV no MVP</div>
                    <div class="small">
                      Para simular o “texto do currículo”, você pode colar o conteúdo em <strong>Detalhes → Texto do CV</strong>.
                      Depois, o sistema estima o match pela vaga.
                    </div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-ghost" type="button" data-bs-dismiss="modal">
            <i class="bi bi-x-lg me-1"></i>Cancelar
          </button>
          <button class="btn btn-brand" type="button" id="btnSaveCand">
            <i class="bi bi-check2 me-1"></i>Salvar candidato
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ TOASTS ============ -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
    <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <i class="bi bi-bell me-2" style="color: var(--lt-brand)"></i>
        <strong class="me-auto">Portal RH</strong>
        <small class="text-muted" id="toastWhen">agora</small>
        <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body" id="toastMsg">—</div>
    </div>
  </div>

      @section Topbar {
<div class="d-flex align-items-center gap-2">
            <button class="btn btn-ghost d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar">
              <i class="bi bi-list"></i>
            </button>

            <div class="d-none d-md-block">
              <div class="fw-bold" style="color:var(--lt-primary); line-height:1.05;">Liotécnica • Portal RH</div>
              <small class="text-muted">Tela: Candidatos (status + match por vaga)</small>
            </div>
          </div>

          <div class="searchbox position-relative d-none d-md-block">
            <i class="bi bi-search"></i>
            <input id="globalSearch" class="form-control" placeholder="Buscar por nome, email, vaga..." />
          </div>

          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-ghost" type="button" id="btnExportJson" title="Exportar candidatos (JSON)">
              <i class="bi bi-download"></i><span class="d-none d-sm-inline ms-1">Exportar</span>
            </button>

            <button class="btn btn-ghost" type="button" id="btnImportJson" title="Importar candidatos (JSON)">
              <i class="bi bi-upload"></i><span class="d-none d-sm-inline ms-1">Importar</span>
            </button>

            <button class="btn btn-brand" type="button" id="btnNewCand">
              <i class="bi bi-plus-lg"></i><span class="d-none d-sm-inline ms-1">Novo candidato</span>
            </button>

            <div class="dropdown">
              <button class="btn btn-ghost dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle me-1"></i><span class="d-none d-sm-inline">RH</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#"><i class="bi bi-person-gear me-2"></i>Meu perfil</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-bell me-2"></i>Notificações</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-box-arrow-right me-2"></i>Sair</a></li>
              </ul>
            </div>
          </div>
}

      <!-- CONTENT -->
      <section class="content">
        <div class="page-title">
          <div>
            <h4>Candidatos</h4>
            <div class="subtitle">Acompanhe candidatos por vaga, status e match estimado (MVP keyword).</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge-soft"><i class="bi bi-clock me-1"></i><span id="nowLabel">—</span></span>
            <span class="badge-soft"><i class="bi bi-lightning-charge me-1"></i>MVP localStorage</span>
          </div>
        </div>

        <!-- KPIs -->
        <div class="row g-3">
          <div class="col-12 col-md-6 col-xl-3">
            <div class="card-soft kpi">
              <div class="meta">
                <div class="label">Total</div>
                <div class="value" id="kpiTotal">0</div>
                <div class="hint">candidatos</div>
              </div>
              <div class="icon"><i class="bi bi-people"></i></div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <div class="card-soft kpi">
              <div class="meta">
                <div class="label">Em triagem</div>
                <div class="value" id="kpiTriagem">0</div>
                <div class="hint">aguardando análise</div>
              </div>
              <div class="icon"><i class="bi bi-funnel"></i></div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <div class="card-soft kpi">
              <div class="meta">
                <div class="label">Aprovados</div>
                <div class="value" id="kpiAprov">0</div>
                <div class="hint">em avanço</div>
              </div>
              <div class="icon"><i class="bi bi-check2-circle"></i></div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <div class="card-soft kpi">
              <div class="meta">
                <div class="label">Reprovados</div>
                <div class="value" id="kpiReprov">0</div>
                <div class="hint">fora do perfil</div>
              </div>
              <div class="icon"><i class="bi bi-x-circle"></i></div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <!-- LISTA -->
          <div class="col-12">
            <div class="card-soft p-3">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                <div>
                  <p class="mini-title mb-1">Lista</p>
                  <div class="fw-bold">Candidatos cadastrados</div>
                  <div class="text-muted small">Use o botao Detalhes para ver e editar o candidato.</div>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-ghost btn-sm" id="btnSeedReset" type="button" title="Restaurar dados de exemplo">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset demo
                  </button>
                </div>
              </div>

              <!-- filtros -->
              <div class="row g-2 mb-2">
                <div class="col-12 col-md-6">
                  <div class="input-group">
                    <span class="input-group-text" style="border-color:var(--lt-border); background: rgba(255,255,255,.65);">
                      <i class="bi bi-search"></i>
                    </span>
                    <input class="form-control" id="fSearch" placeholder="Buscar por nome, email, vaga..." style="border-color:var(--lt-border);">
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <select class="form-select" id="fStatus" style="border-color:var(--lt-border);">
                    <option value="all">Status: todos</option>
                    <option value="novo">Novo</option>
                    <option value="triagem">Em triagem</option>
                    <option value="aprovado">Aprovado</option>
                    <option value="reprovado">Reprovado</option>
                    <option value="pendente">Pendente</option>
                  </select>
                </div>
                <div class="col-6 col-md-3">
                  <select class="form-select" id="fVaga" style="border-color:var(--lt-border);">
                    <option value="all">Vaga: todas</option>
                  </select>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table align-middle mb-0">
                  <thead>
                    <tr>
                      <th style="min-width: 260px;">Candidato</th>
                      <th style="min-width: 220px;">Vaga</th>
                      <th style="min-width: 150px;">Status</th>
                      <th style="min-width: 170px;">Match</th>
                      <th class="text-end" style="min-width: 230px;">Ações</th>
                    </tr>
                  </thead>
                  <tbody id="tblCands"></tbody>
                </table>
              </div>

              <div class="mt-2 small text-muted">
                MVP: candidatos + “texto do CV” ficam no <span class="mono">localStorage</span>.
              </div>
            </div>
          </div>

          <!-- DETALHES (DESKTOP) -->
        </div>

        <div style="height: 14px;"></div>
      </section>

      @section Footer {
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>© <span id="year"></span> Liotécnica • Portal RH (MVP)</div>
          <div class="d-flex align-items-center gap-3">
            <span><i class="bi bi-people me-1"></i>Candidatos</span>
            <span><i class="bi bi-file-earmark-text me-1"></i>CV</span>
            <span><i class="bi bi-stars me-1"></i>Match</span>
          </div>
        </div>
}

    

  <!-- Bootstrap JS (CDN) -->

@section Scripts {
<script>
    // ========= Logo (mesmo Data URI usado antes)
    const LOGO_DATA_URI = "data:image/webp;base64,UklGRngUAABXRUJQVlA4IGwUAAAQYwCdASpbAVsBPlEokUajoqGhIpNoyHAK7AQYJjYQmG9Dtu/6p6QZ4lQd6lPde+Jk3i3kG2EoP+QW0c0h8Oe3jW2C5zE0o9jzZ1x2fX9cZlX0d7rW8r0vQ9p3d2nJ1bqzQfQZxVwTt7mJvU8j1GqF4oJc8Qb+gq+oQyHcQyYc2b9u2fYf0Rj9x9hRZp2Y2xK0yVQ8Hj4p6w8B1K2cKk2mY9m2r8kz3a4m7xG4xg9m5VjzP3E4RjQH8fYkC4mB8g0vR3c5h1D0yE8Qzv7t7gQj0Z9yKk3cWZgVnq3l1kq6rE8oWc4z6oZk8k0b1o9m8p2m+QJ3nJm6GgA=";

    // ========= Helpers
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

    function uid(){
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    }
    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function toast(msg){
      $("#toastMsg").textContent = msg;
      $("#toastWhen").textContent = "agora";
      bootstrap.Toast.getOrCreateInstance($("#appToast"), { delay: 2400 }).show();
    }

    function normalizeText(s){
      return (s || "")
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9#+\s]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function initials(name){
      const parts = (name || "").trim().split(/\s+/).filter(Boolean);
      if(!parts.length) return "—";
      const a = parts[0][0] || "";
      const b = parts.length > 1 ? (parts[parts.length-1][0] || "") : "";
      return (a + b).toUpperCase();
    }

    function statusTag(s){
      const map = {
        novo:      { label:"Novo", cls:"" },
        triagem:   { label:"Em triagem", cls:"warn" },
        aprovado:  { label:"Aprovado", cls:"ok" },
        reprovado: { label:"Reprovado", cls:"bad" },
        pendente:  { label:"Pendente", cls:"warn" }
      };
      const it = map[s] || { label: s, cls:"" };
      return `<span class="status-tag ${it.cls}"><i class="bi bi-dot"></i>${escapeHtml(it.label)}</span>`;
    }

    // ========= Storage keys
    // Vagas: reaproveita o mesmo key do arquivo anterior
    const VAGAS_KEY = "lt_rh_vagas_v1";
    const CANDS_KEY = "lt_rh_candidatos_v1";

    const state = {
      vagas: [],
      candidatos: [],
      selectedId: null,
      filters: { q:"", status:"all", vagaId:"all" }
    };

    function loadVagas(){
      try{
        const raw = localStorage.getItem(VAGAS_KEY);
        if(!raw) return [];
        const data = JSON.parse(raw);
        if(!data || !Array.isArray(data.vagas)) return [];
        return data.vagas;
      }catch{ return []; }
    }

    function loadCands(){
      try{
        const raw = localStorage.getItem(CANDS_KEY);
        if(!raw) return false;
        const data = JSON.parse(raw);
        if(!data || !Array.isArray(data.candidatos)) return false;
        state.candidatos = data.candidatos;
        state.selectedId = data.selectedId ?? null;
        return true;
      }catch{ return false; }
    }

    function saveCands(){
      localStorage.setItem(CANDS_KEY, JSON.stringify({
        candidatos: state.candidatos,
        selectedId: state.selectedId
      }));
    }

    function seedCandsIfEmpty(){
      if(state.candidatos.length) return;

      const v = state.vagas[0] || null;

      const c1 = {
        id: uid(),
        nome: "Mariana Souza",
        email: "mariana.souza@@email.com",
        fone: "(11) 98888-7777",
        cidade: "Embu das Artes",
        uf: "SP",
        fonte: "Email",
        status: "triagem",
        vagaId: v?.id || "",
        obs: "Boa comunicação. Experiência com marketing digital.",
        cvText: "Experiência com campanhas de performance, google analytics, excel, dashboards e power bi. Rotina com metas e relatórios.",
        createdAt: new Date(Date.now() - 1000*60*60*24*2).toISOString(),
        updatedAt: new Date(Date.now() - 1000*60*60*4).toISOString(),
        lastMatch: null
      };

      const c2 = {
        id: uid(),
        nome: "Carlos Henrique",
        email: "carlos.h@@email.com",
        fone: "(11) 97777-1111",
        cidade: "São Paulo",
        uf: "SP",
        fonte: "LinkedIn",
        status: "novo",
        vagaId: v?.id || "",
        obs: "",
        cvText: "Atuação como analista. Excel avançado. Noções de BI.",
        createdAt: new Date(Date.now() - 1000*60*60*24*1).toISOString(),
        updatedAt: new Date(Date.now() - 1000*60*60*24*1).toISOString(),
        lastMatch: null
      };

      const c3 = {
        id: uid(),
        nome: "Ana Paula Ribeiro",
        email: "ana.ribeiro@@email.com",
        fone: "(11) 96666-2222",
        cidade: "Osasco",
        uf: "SP",
        fonte: "Indicação",
        status: "aprovado",
        vagaId: v?.id || "",
        obs: "Perfil excelente. Forte em BI.",
        cvText: "PowerBI, SQL, modelagem dimensional e analytics. Experiência com indicadores e apresentações para diretoria.",
        createdAt: new Date(Date.now() - 1000*60*60*24*6).toISOString(),
        updatedAt: new Date(Date.now() - 1000*60*60*24*2).toISOString(),
        lastMatch: null
      };

      state.candidatos = [c1, c2, c3];
      state.selectedId = c1.id;
      saveCands();
    }

    function findVaga(id){
      return state.vagas.find(v => v.id === id) || null;
    }
    function findCand(id){
      return state.candidatos.find(c => c.id === id) || null;
    }

    // ========= Matching (MVP keyword)
    function calcMatchForCand(cand){
      const v = findVaga(cand.vagaId);
      if(!v) return { score: 0, pass: false, hits: [], missMandatory: [], totalPeso: 1, hitPeso: 0 };

      const text = normalizeText(cand.cvText || "");
      const reqs = (v.requisitos || []);
      if(!text || !reqs.length){
        const thr = clamp(parseInt(v.threshold || 0,10)||0,0,100);
        return { score: 0, pass: 0 >= thr, hits: [], missMandatory: [], totalPeso: 1, hitPeso: 0 };
      }

      const totalPeso = reqs.reduce((acc, r)=> acc + clamp(parseInt(r.peso||0,10)||0,0,10), 0) || 1;
      let hitPeso = 0;
      const hits = [];
      const missMandatory = [];

      reqs.forEach(r => {
        const termo = normalizeText(r.termo || "");
        const syns = (r.sinonimos || []).map(normalizeText).filter(Boolean);
        const bag = [termo, ...syns].filter(Boolean);

        const found = bag.some(t => t && text.includes(t));
        const p = clamp(parseInt(r.peso||0,10)||0,0,10);

        if(found){
          hitPeso += p;
          hits.push(r);
        }else if(r.obrigatorio){
          missMandatory.push(r);
        }
      });

      let score = Math.round((hitPeso / totalPeso) * 100);
      if(missMandatory.length){
        score = Math.max(0, score - Math.min(40, missMandatory.length * 15));
      }

      const thr = clamp(parseInt(v.threshold || 0,10)||0,0,100);
      const pass = score >= thr;

      return { score, pass, hits, missMandatory, totalPeso, hitPeso, threshold: thr };
    }

    function matchLabel(score, thr){
      const s = clamp(parseInt(score||0,10)||0,0,100);
      const t = clamp(parseInt(thr||0,10)||0,0,100);
      const ok = s >= t;
      const cls = ok ? "ok" : (s >= (t*0.8) ? "warn" : "bad");
      const text = ok ? "Dentro" : "Abaixo";
      return `<span class="status-tag ${cls}"><i class="bi bi-stars"></i>${s}% • ${text}</span>`;
    }

    // ========= KPIs
    function updateKpis(){
      const total = state.candidatos.length;
      const triagem = state.candidatos.filter(c => c.status === "triagem").length;
      const aprov = state.candidatos.filter(c => c.status === "aprovado").length;
      const repro = state.candidatos.filter(c => c.status === "reprovado").length;

      $("#kpiTotal").textContent = total;
      $("#kpiTriagem").textContent = triagem;
      $("#kpiAprov").textContent = aprov;
      $("#kpiReprov").textContent = repro;
    }

    // ========= Filters
    function distinctVagas(){
      return state.vagas
        .map(v => ({ id: v.id, label: `${v.titulo || "—"} (${v.codigo || "—"})` }))
        .sort((a,b)=>a.label.localeCompare(b.label, "pt-BR"));
    }

    function renderVagaFilters(){
      // filtro do grid
      const sel = $("#fVaga");
      const cur = sel.value || "all";
      const opts = distinctVagas().map(v => `<option value="${v.id}">${escapeHtml(v.label)}</option>`).join("");
      sel.innerHTML = `<option value="all">Vaga: todas</option>` + opts;
      sel.value = (cur === "all" || state.vagas.some(v => v.id === cur)) ? cur : "all";

      // dropdown do modal
      const sel2 = $("#candVaga");
      sel2.innerHTML = `<option value="">Selecione...</option>` + distinctVagas().map(v => `<option value="${v.id}">${escapeHtml(v.label)}</option>`).join("");
    }

    function getFilteredCands(){
      const q = (state.filters.q || "").trim().toLowerCase();
      const st = state.filters.status;
      const vid = state.filters.vagaId;

      return state.candidatos.filter(c => {
        if(st !== "all" && c.status !== st) return false;
        if(vid !== "all" && c.vagaId !== vid) return false;

        if(!q) return true;

        const v = findVaga(c.vagaId);
        const blob = [
          c.nome, c.email, c.fone,
          v?.titulo, v?.codigo,
          c.cidade, c.uf, c.fonte, c.status
        ].join(" ").toLowerCase();

        return blob.includes(q);
      });
    }

    // ========= Rendering list
    function renderList(){
      const tbody = $("#tblCands");
      tbody.innerHTML = "";

      const rows = getFilteredCands();
      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">Nenhum candidato encontrado com os filtros atuais.</td></tr>`;
        return;
      }

      rows.forEach(c => {
        const v = findVaga(c.vagaId);
        const vagaTxt = v ? `${v.titulo || "—"} (${v.codigo || "—"})` : "—";
        const isSel = c.id === state.selectedId;

        const m = calcMatchForCand(c);
        const thr = m.threshold ?? (v ? v.threshold : 0);

        const tr = document.createElement("tr");
        tr.style.cursor = "default";
        tr.className = isSel ? "table-active" : "";
        tr.innerHTML = `
          <td>
            <div class="d-flex align-items-center gap-2">
              <div class="avatar">${escapeHtml(initials(c.nome))}</div>
              <div>
                <div class="fw-bold">${escapeHtml(c.nome || "—")}</div>
                <div class="text-muted small">
                  <span>${escapeHtml(c.email || "—")}</span>
                  ${c.fone ? `<span class="mx-2">•</span><span>${escapeHtml(c.fone)}</span>` : ""}
                </div>
              </div>
            </div>
          </td>
          <td class="nowrap">
            <div class="fw-semibold">${escapeHtml(v?.titulo || "—")}</div>
            <div class="text-muted small mono">${escapeHtml(v?.codigo || "—")}</div>
          </td>
          <td class="nowrap">${statusTag(c.status)}</td>
          <td class="nowrap">
            ${v ? matchLabel(m.score, thr) : `<span class="text-muted">—</span>`}
          </td>
          <td class="text-end nowrap">
            <button class="btn btn-ghost btn-sm me-1" data-act="detail" data-id="${c.id}">
              <i class="bi bi-layout-text-window me-1"></i>Detalhes
            </button>
            <button class="btn btn-ghost btn-sm me-1" data-act="edit" data-id="${c.id}">
              <i class="bi bi-pencil me-1"></i>Editar
            </button>
            <button class="btn btn-ghost btn-sm me-1" data-act="recalc" data-id="${c.id}" title="Recalcular match">
              <i class="bi bi-arrow-repeat"></i>
            </button>
            <button class="btn btn-ghost btn-sm text-danger" data-act="del" data-id="${c.id}" title="Excluir">
              <i class="bi bi-trash3"></i>
            </button>
          </td>
        `;

        tr.addEventListener("click", (ev) => {
          const btn = ev.target.closest("button[data-act]");
          if(btn){
            ev.preventDefault();
            ev.stopPropagation();
            const act = btn.dataset.act;
            const id = btn.dataset.id;
            if(act === "detail") openDetailModal(id);
            if(act === "edit") openCandModal("edit", id);
            if(act === "recalc") recalcMatch(id);
            if(act === "del") deleteCand(id);
            return;
          }
        });

        tbody.appendChild(tr);
      });
    }

    function selectCand(id){
      state.selectedId = id;
      saveCands();
      renderList();
      renderDetail();
    }

function openDetailModal(id){
      selectCand(id);
      const modal = bootstrap.Modal.getOrCreateInstance($("#modalCandDetalhes"));
      modal.show();
    }

    // ========= Detail UI
    function buildDetailHtml(c){
      if(!c){
        return `
          <div class="detail-empty">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-info-circle mt-1"></i>
              <div>
                <div class="fw-bold">Selecione um candidato</div>
                <div class="small mt-1">Use o botao Detalhes na lista para ver match, editar status e texto do CV.</div>
              </div>
            </div>
          </div>
        `;
      }

      const v = findVaga(c.vagaId);
      const updated = c.updatedAt ? new Date(c.updatedAt) : null;
      const updatedTxt = updated ? updated.toLocaleString("pt-BR", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" }) : "—";

      const m = calcMatchForCand(c);
      const thr = m.threshold ?? (v ? v.threshold : 0);
      const pass = !!m.pass;

      const hits = (m.hits || []).map(r => r.termo).slice(0, 12);
      const misses = (m.missMandatory || []).map(r => r.termo).slice(0, 12);

      return `
        <div class="card-soft p-3">
          <div class="d-flex flex-wrap align-items-start justify-content-between gap-2 mb-2">
            <div class="d-flex align-items-center gap-2">
              <div class="avatar" style="width:52px;height:52px;border-radius:16px;">${escapeHtml(initials(c.nome))}</div>
              <div>
                <div class="fw-bold" style="font-size:1.05rem;">${escapeHtml(c.nome || "—")}</div>
                <div class="text-muted small">
                  <span>${escapeHtml(c.email || "—")}</span>
                  ${c.fone ? `<span class="mx-2">•</span><span>${escapeHtml(c.fone)}</span>` : ""}
                </div>
                <div class="text-muted small">
                  ${[c.cidade, c.uf].filter(Boolean).length ? `<i class="bi bi-geo-alt me-1"></i>${escapeHtml([c.cidade, c.uf].filter(Boolean).join(" - "))}` : `<span>—</span>`}
                  <span class="mx-2">•</span>
                  <i class="bi bi-send me-1"></i>${escapeHtml(c.fonte || "—")}
                </div>
              </div>
            </div>

            <div class="text-end">
              <div class="mb-1">${statusTag(c.status)}</div>
              <div class="text-muted small">Atualizado: ${escapeHtml(updatedTxt)}</div>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 mb-3">
            <span class="pill"><i class="bi bi-briefcase"></i>${escapeHtml(v ? (v.titulo || "—") : "Vaga não vinculada")}</span>
            ${v ? `<span class="pill mono">${escapeHtml(v.codigo || "—")}</span>` : ""}
            ${v ? `<span class="pill"><i class="bi bi-stars"></i>Match mín.: <strong class="ms-1">${clamp(parseInt(thr||0,10)||0,0,100)}%</strong></span>` : ""}
          </div>

          <ul class="nav nav-pills gap-2 mb-3" style="background: rgba(173,200,220,.16); padding: .35rem; border-radius: 999px; border: 1px solid rgba(16,82,144,.14);">
            <li class="nav-item">
              <button class="nav-link active rounded-pill" data-bs-toggle="pill" data-bs-target="#tabResumo" type="button">
                <i class="bi bi-card-text me-1"></i>Resumo
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link rounded-pill" data-bs-toggle="pill" data-bs-target="#tabCV" type="button">
                <i class="bi bi-file-earmark-text me-1"></i>Texto do CV
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link rounded-pill" data-bs-toggle="pill" data-bs-target="#tabMatch" type="button">
                <i class="bi bi-stars me-1"></i>Match
              </button>
            </li>
          </ul>

          <div class="tab-content">
            <div class="tab-pane fade show active" id="tabResumo">
              <div class="fw-semibold mb-1">Observações</div>
              <div class="text-muted small mb-3">${escapeHtml(c.obs || "—")}</div>

              <div class="row g-2">
                <div class="col-12 col-md-6">
                  <div class="card-soft p-2" style="box-shadow:none;">
                    <div class="small text-muted">Status</div>
                    <select class="form-select form-select-sm mt-1" id="detailStatus">
                      <option value="novo" ${c.status==="novo"?"selected":""}>Novo</option>
                      <option value="triagem" ${c.status==="triagem"?"selected":""}>Em triagem</option>
                      <option value="aprovado" ${c.status==="aprovado"?"selected":""}>Aprovado</option>
                      <option value="reprovado" ${c.status==="reprovado"?"selected":""}>Reprovado</option>
                      <option value="pendente" ${c.status==="pendente"?"selected":""}>Pendente</option>
                    </select>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="card-soft p-2" style="box-shadow:none;">
                    <div class="small text-muted">Vaga</div>
                    <select class="form-select form-select-sm mt-1" id="detailVaga">
                      ${renderVagaOptionsHtml(c.vagaId)}
                    </select>
                  </div>
                </div>
              </div>

              <div class="d-flex flex-wrap gap-2 mt-3">
                <button class="btn btn-ghost btn-sm" type="button" data-dact="edit">
                  <i class="bi bi-pencil me-1"></i>Editar
                </button>
                <button class="btn btn-ghost btn-sm" type="button" data-dact="saveMeta">
                  <i class="bi bi-check2 me-1"></i>Salvar status/vaga
                </button>
                <button class="btn btn-ghost btn-sm text-danger" type="button" data-dact="delete">
                  <i class="bi bi-trash3 me-1"></i>Excluir
                </button>
              </div>
            </div>

            <div class="tab-pane fade" id="tabCV">
              <div class="fw-semibold mb-1">Texto do CV (para simulação no MVP)</div>
              <div class="text-muted small mb-2">
                No produto final, isso virá de OCR/parse do PDF/DOCX + dados do email/pasta.
              </div>
              <textarea class="form-control" rows="8" id="detailCvText" placeholder="Cole aqui o texto do currículo...">${escapeHtml(c.cvText || "")}</textarea>
              <div class="d-flex flex-wrap gap-2 mt-2">
                <button class="btn btn-ghost btn-sm" type="button" data-dact="saveCv">
                  <i class="bi bi-save me-1"></i>Salvar texto
                </button>
                <button class="btn btn-ghost btn-sm" type="button" data-dact="recalc">
                  <i class="bi bi-arrow-repeat me-1"></i>Recalcular match
                </button>
              </div>
            </div>

            <div class="tab-pane fade" id="tabMatch">
              ${v ? `
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <div class="fw-bold">Resultado atual</div>
                    <div class="text-muted small">Score por palavras-chave (MVP)</div>
                  </div>
                  <span class="status-tag ${pass ? "ok" : "bad"}">
                    <i class="bi bi-${pass ? "check2-circle" : "x-circle"}"></i>
                    ${pass ? "Dentro" : "Abaixo"} do mínimo
                  </span>
                </div>

                <div class="mt-2">
                  <div class="d-flex align-items-center gap-2">
                    <div class="progress flex-grow-1">
                      <div class="progress-bar" style="width:${clamp(m.score,0,100)}%"></div>
                    </div>
                    <div class="fw-bold" style="min-width:54px;text-align:right;">${clamp(m.score,0,100)}%</div>
                  </div>
                  <div class="text-muted small mt-1">
                    Match mínimo da vaga: <strong>${clamp(parseInt(thr||0,10)||0,0,100)}%</strong>
                    • Encontrados: <strong>${(m.hits||[]).length}</strong>
                    • Obrigatórios faltando: <strong>${(m.missMandatory||[]).length}</strong>
                  </div>
                </div>

                ${(m.missMandatory||[]).length ? `
                  <div class="alert alert-danger mt-3 mb-0" style="border-radius:14px;">
                    <div class="fw-semibold mb-1"><i class="bi bi-exclamation-triangle me-1"></i>Obrigatórios não encontrados</div>
                    <div class="small">${escapeHtml(misses.join(", "))}</div>
                  </div>
                ` : ""}

                <div class="mt-3">
                  <div class="fw-semibold mb-1">Encontrados</div>
                  <div class="small text-muted">${hits.length ? escapeHtml(hits.join(", ")) : "—"}</div>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-3">
                  <button class="btn btn-ghost btn-sm" type="button" data-dact="recalc">
                    <i class="bi bi-arrow-repeat me-1"></i>Recalcular
                  </button>
                  <button class="btn btn-ghost btn-sm" type="button" data-dact="openVaga">
                    <i class="bi bi-briefcase me-1"></i>Abrir vaga (placeholder)
                  </button>
                </div>
              ` : `
                <div class="alert alert-warning" style="border-radius:14px;">
                  Vincule uma vaga ao candidato para calcular o match.
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderVagaOptionsHtml(selectedId){
      const opts = distinctVagas()
        .map(v => `<option value="${v.id}" ${v.id===selectedId?"selected":""}>${escapeHtml(v.label)}</option>`)
        .join("");
      return `<option value="">Selecione...</option>` + opts;
    }

    function renderDetail(){
      const c = findCand(state.selectedId);
      $("#detailHost").innerHTML = buildDetailHtml(c);
      bindDetailActions(c);
    }

    function bindDetailActions(c){
      if(!c) return;

      $$("#detailHost [data-dact]").forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.dataset.dact;
          if(act === "edit") openCandModal("edit", c.id);
          if(act === "delete") deleteCand(c.id);
          if(act === "saveCv") saveCvText(c.id, false);
          if(act === "recalc") recalcMatch(c.id);
          if(act === "saveMeta") saveMeta(c.id, false);
          if(act === "openVaga") toast("Placeholder: aqui abriria a tela de Vagas filtrada na vaga.");
        });
      });
    }

    
    // ========= CRUD: Candidatos
    function openCandModal(mode, id){
      const modal = bootstrap.Modal.getOrCreateInstance($("#modalCand"));
      const isEdit = mode === "edit";
      $("#modalCandTitle").textContent = isEdit ? "Editar candidato" : "Novo candidato";

      // refresh vagas dropdown
      renderVagaFilters();

      if(isEdit){
        const c = findCand(id);
        if(!c) return;
        $("#candId").value = c.id;
        $("#candNome").value = c.nome || "";
        $("#candEmail").value = c.email || "";
        $("#candFone").value = c.fone || "";
        $("#candCidade").value = c.cidade || "";
        $("#candUF").value = (c.uf || "").toUpperCase().slice(0,2);
        $("#candFonte").value = c.fonte || "Email";
        $("#candStatus").value = c.status || "novo";
        $("#candVaga").value = c.vagaId || "";
        $("#candObs").value = c.obs || "";
      }else{
        $("#candId").value = "";
        $("#candNome").value = "";
        $("#candEmail").value = "";
        $("#candFone").value = "";
        $("#candCidade").value = "";
        $("#candUF").value = "SP";
        $("#candFonte").value = "Email";
        $("#candStatus").value = "novo";
        $("#candVaga").value = state.vagas[0]?.id || "";
        $("#candObs").value = "";
      }

      modal.show();
    }

    function upsertCandFromModal(){
      const id = $("#candId").value || null;
      const nome = ($("#candNome").value || "").trim();
      const email = ($("#candEmail").value || "").trim();
      const fone = ($("#candFone").value || "").trim();
      const cidade = ($("#candCidade").value || "").trim();
      const uf = ($("#candUF").value || "").trim().toUpperCase().slice(0,2);
      const fonte = ($("#candFonte").value || "").trim();
      const status = ($("#candStatus").value || "").trim();
      const vagaId = ($("#candVaga").value || "").trim();
      const obs = ($("#candObs").value || "").trim();

      if(!nome){ toast("Informe o nome do candidato."); return; }
      if(!email){ toast("Informe o email do candidato."); return; }
      if(!vagaId){ toast("Selecione uma vaga."); return; }

      const now = new Date().toISOString();

      if(id){
        const c = findCand(id);
        if(!c) return;

        c.nome = nome;
        c.email = email;
        c.fone = fone;
        c.cidade = cidade;
        c.uf = uf;
        c.fonte = fonte;
        c.status = status;
        c.vagaId = vagaId;
        c.obs = obs;
        c.updatedAt = now;

        toast("Candidato atualizado.");
        state.selectedId = c.id;
      }else{
        const c = {
          id: uid(),
          nome, email, fone, cidade, uf,
          fonte, status, vagaId, obs,
          cvText: "",
          createdAt: now,
          updatedAt: now,
          lastMatch: null
        };
        state.candidatos.unshift(c);
        state.selectedId = c.id;
        toast("Candidato criado.");
      }

      saveCands();
      updateKpis();
      renderVagaFilters();
      renderList();
      renderDetail();
      bootstrap.Modal.getOrCreateInstance($("#modalCand")).hide();
    }

    function deleteCand(id){
      const c = findCand(id);
      if(!c) return;

      const ok = confirm(`Excluir o candidato "${c.nome}"?`);
      if(!ok) return;

      state.candidatos = state.candidatos.filter(x => x.id !== id);
      if(state.selectedId === id){
        state.selectedId = state.candidatos[0]?.id || null;
      }
      saveCands();
      updateKpis();
      renderList();
      renderDetail();
      toast("Candidato excluído.");
    }

    function saveCvText(candId, fromMobile){
      const c = findCand(candId);
      if(!c) return;

      const root = fromMobile ? $("#mobileDetailBody") : $("#detailHost");
      const ta = root.querySelector("#detailCvText");
      c.cvText = (ta?.value || "");
      c.updatedAt = new Date().toISOString();
      saveCands();
      renderList();
      renderDetail();
      toast("Texto do CV salvo.");
    }

    function saveMeta(candId, fromMobile){
      const c = findCand(candId);
      if(!c) return;

      const root = fromMobile ? $("#mobileDetailBody") : $("#detailHost");
      const st = root.querySelector("#detailStatus")?.value || c.status;
      const vid = root.querySelector("#detailVaga")?.value || c.vagaId;

      c.status = st;
      c.vagaId = vid;
      c.updatedAt = new Date().toISOString();
      saveCands();
      updateKpis();
      renderList();
      renderDetail();
      toast("Status/Vaga atualizados.");
    }

    function recalcMatch(candId){
      const c = findCand(candId);
      if(!c) return;

      const m = calcMatchForCand(c);
      c.lastMatch = { score: m.score, pass: m.pass, at: new Date().toISOString() };
      c.updatedAt = new Date().toISOString();

      saveCands();
      renderList();
      renderDetail();
      toast("Match recalculado.");
    }

    // ========= Import/Export
    function exportJson(){
      const payload = { version: 1, exportedAt: new Date().toISOString(), candidatos: state.candidatos };
      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "candidatos_mvp_liotecnica.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exportação iniciada.");
    }

    function importJson(){
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json";
      inp.onchange = () => {
        const file = inp.files && inp.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = () => {
          try{
            const data = JSON.parse(reader.result);
            if(!data || !Array.isArray(data.candidatos)) throw new Error("Formato inválido.");

            state.candidatos = data.candidatos.map(c => ({
              id: c.id || uid(),
              nome: c.nome || "",
              email: c.email || "",
              fone: c.fone || "",
              cidade: c.cidade || "",
              uf: (c.uf || "").toUpperCase().slice(0,2),
              fonte: c.fonte || "Email",
              status: c.status || "novo",
              vagaId: c.vagaId || "",
              obs: c.obs || "",
              cvText: c.cvText || "",
              createdAt: c.createdAt || new Date().toISOString(),
              updatedAt: c.updatedAt || new Date().toISOString(),
              lastMatch: c.lastMatch || null
            }));

            state.selectedId = state.candidatos[0]?.id || null;
            saveCands();
            updateKpis();
            renderVagaFilters();
            renderList();
            renderDetail();
            toast("Importação concluída.");
          }catch(e){
            console.error(e);
            alert("Falha ao importar JSON. Verifique o arquivo.");
          }
        };
        reader.readAsText(file);
      };
      inp.click();
    }

    // ========= UI wiring
    function wireClock(){
      const now = new Date();
      $("#year").textContent = now.getFullYear();

      const tick = () => {
        const d = new Date();
        $("#nowLabel").textContent = d.toLocaleString("pt-BR", {
          weekday:"short", day:"2-digit", month:"2-digit",
          hour:"2-digit", minute:"2-digit"
        });
      };
      tick();
      setInterval(tick, 1000 * 15);
    }

    function wireFilters(){
      const apply = () => {
        state.filters.q = ($("#fSearch").value || "").trim();
        state.filters.status = $("#fStatus").value || "all";
        state.filters.vagaId = $("#fVaga").value || "all";
        renderList();
      };

      $("#fSearch").addEventListener("input", apply);
      $("#fStatus").addEventListener("change", apply);
      $("#fVaga").addEventListener("change", apply);

      $("#globalSearch").addEventListener("input", () => {
        $("#fSearch").value = $("#globalSearch").value;
        apply();
      });
    }

    function wireButtons(){
      $("#btnNewCand").addEventListener("click", () => openCandModal("new"));
      $("#btnSaveCand").addEventListener("click", upsertCandFromModal);

      $("#btnExportJson").addEventListener("click", exportJson);
      $("#btnImportJson").addEventListener("click", importJson);

      $("#btnSeedReset").addEventListener("click", () => {
        const ok = confirm("Restaurar dados de exemplo? Isso substitui seus candidatos atuais no MVP.");
        if(!ok) return;
        state.candidatos = [];
        state.selectedId = null;
        saveCands();
        seedCandsIfEmpty();
        updateKpis();
        renderVagaFilters();
        renderList();
        renderDetail();
        toast("Demo restaurada.");
      });
    }

    function initLogo(){
      $("#logoDesktop").src = LOGO_DATA_URI;
      $("#logoMobile").src = LOGO_DATA_URI;
    }

    // ========= Init
    (function init(){
      initLogo();
      wireClock();

      state.vagas = loadVagas();

      // caso o usuário ainda não tenha aberto a tela de Vagas (sem dados)
      if(!state.vagas.length){
        toast("Nenhuma vaga encontrada no localStorage. Abra a tela de Vagas e crie/seed primeiro.");
      }

      const has = loadCands();
      if(!has) seedCandsIfEmpty();
      else seedCandsIfEmpty();

      renderVagaFilters();
      updateKpis();
      renderList();
      renderDetail();

      wireFilters();
      wireButtons();

      if(!state.selectedId && state.candidatos.length){
        state.selectedId = state.candidatos[0].id;
        saveCands();
        renderList();
        renderDetail();
      }
    })();
  </script>
}
